<html>
<head>
<link rel="stylesheet" type="text/css" href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js" ></script>
<script>
function outputMessage(msg, noOverride) {	
	if (window.consoleClearTimer) {
		if (noOverride) {
			return;
		}
		clearTimeout(window.consoleClearTimer);
		window.consoleClearTimer = null;
	}
	
	var output = $("#output");
	output.html(msg);
	
	window.consoleClearTimer = setTimeout(function () { 
		output.html('');
		window.consoleClearTimer = null;
	}, 10000);
}

function insertAd() {
	var videoTag = $("#videoTag")[0];

	if (videoTag.currentTime == 0) {
		outputMessage("<b>Failed</b>: couldn't get video player position");
		return;
	}

	var insertAdRequest = "@EXTERNAL_URL@/insertAd.js?entryId=" + window.entryId + "&uid=@UID@&currentTime=" + videoTag.currentTime + "&adSlotDuration=" + window.adSlotDuration;
	$.ajax({
		url: insertAdRequest
	}).done(function( data ) {
		outputMessage("<b>Done</b>: " + data);
	}).fail(function( data ) {
		outputMessage("<b>Failed</b>: " + data.responseText);
	});
}

function startAdInsertTimer() {
	var interval = Math.floor((Math.random() * 20000) + 40000);		// 40 - 60 seconds
	setTimeout(function() {
		insertAd();
		startAdInsertTimer();
	}, interval);
}

function verifyPlayingRealTime() {
	var videoTag = $("#videoTag")[0];

	if (videoTag.currentTime == 0) {
		return;
	}

	var currentLag = videoTag.seekable.end(0) - videoTag.currentTime;
	if (currentLag > 30)
		outputMessage("<b>Warning</b>: player is lagging real-time by " + (Math.round(currentLag * 100) / 100) + " seconds, in order to place ads seek to the end", true);
}

function start() {
	// read form settings
	var origUrl = $("#origUrl").val();
	var autoAdInsert = $("#autoAdInsert").is(':checked');

	window.adSlotDuration = $("#adSlotDuration").val();
	window.entryId = $("#entryId").val();
   
	var fullStitchedUrl = '@EXTERNAL_URL@/masterstitch.m3u8?entryId=' + window.entryId + '&url=' + encodeURIComponent(origUrl);
	
	// create a short stitched URL
	var shortUrlRequest = "@EXTERNAL_URL@/shortUrl.js?url=" + encodeURIComponent(fullStitchedUrl);
	$.ajax({
		url: shortUrlRequest
	}).done(function( shortStitchedUrl ) {
		// update video source
		var videoUrl = '@EXTERNAL_URL@/masterproxy.m3u8?uid=@UID@&url=' + encodeURIComponent(origUrl);
		var videoTag = $("#videoTag")[0];
		videoTag.setAttribute("src", videoUrl);

		// update the displayed stitched URL
		$("#stitchedUrl").html('<b>Stitched URL</b>: ' + shortStitchedUrl);
		
		// hide the form, show the player
		$("#formDiv").hide();
		$("#playerDiv").show();	 
	 
		// start timers
		if (autoAdInsert) {
			startAdInsertTimer();
		}
		setInterval(verifyPlayingRealTime, 10000);
	}).fail(function( data ) {
		alert('Failed to get short url');
	});
}
</script>
</head>
<body>
	<div id="formDiv">
		<form>
			<!--
				ABC News:			http://abclive.abcnews.com/i/abc_live4@136330/master.m3u8
				Weather Nation:		http://cdnapi.kaltura.com/p/931702/sp/93170200/playManifest/entryId/0_a7vl6x8e/format/applehttp
				Nasa:				http://public.infozen.cshls.lldns.net/infozen/public/public.m3u8
			-->
			URL: <input type="text" value="http://abclive.abcnews.com/i/abc_live4@136330/master.m3u8" id="origUrl" size="60"><br>
			Entry id: <input type="text" value="@UID@" id="entryId" size="10"><br>
			Ad slot length: <input type="text" value="32" id="adSlotDuration" size="10"><br>
			<input type="checkbox" id="autoAdInsert">Auto ad insertion<br>
			<input type="button" value="start" onclick="start();" id="startbtn">
		</form>
	</div>
  
	<div style="display:none" id="playerDiv">
		<p id="stitchedUrl"></p>
		<div style="width: 400px;">
			<video id="videoTag" height="300" width="400" autoplay="" controls=""/>
		</div>
		<div style="width:400px;text-align:center">
			<button onclick="insertAd()" class="btn btn-danger">Click to Insert Ad</button>
		</div>
		<p id="output"></p>
	</div>
</body>
</html>
